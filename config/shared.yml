# big query logger shared configuration
bigquery_log:
  template: "%Y%m%d%H"
  format: >-
    {
    \"service_id\":\"%{req.service_id}V\",
    \"time_start\":\"%{begin:%Y-%m-%dT%H:%M:%S%Z}t\",
    \"time_end\":\"%{end:%Y-%m-%dT%H:%M:%S%Z}t\",
    \"time_elapsed\":%D,
    \"client_ip\":\"%h\",
    \"client_as_name\":\"%{client.as.name}V\",
    \"client_as_number\":\"%{client.as.number}V\",
    \"client_connection_speed\":\"%{client.geo.conn_speed}V\",
    \"request\":\"%m\",
    \"protocol\":\"%H\",
    \"host\":\"%{Fastly-Orig-Host}i\",
    \"origin_host\":\"%v\",
    \"url\":\"%{cstr_escape(req.url)}V\",
    \"is_ipv6\":%{if(req.is_ipv6, \\\"true\\\", \\\"false\\\")}V,
    \"is_tls\":%{if(req.is_ssl, \\\"true\\\", \\\"false\\\")}V,
    \"tls_client_protocol\":\"%{cstr_escape(tls.client.protocol)}V\",
    \"tls_client_servername\":\"%{cstr_escape(tls.client.servername)}V\",
    \"tls_client_cipher\":\"%{cstr_escape(tls.client.cipher)}V\",
    \"tls_client_cipher_sha\":\"%{cstr_escape(tls.client.ciphers_sha)}V\",
    \"tls_client_tlsexts_sha\":\"%{cstr_escape(tls.client.tlsexts_sha)}V\",
    \"is_h2\":%{if(fastly_info.is_h2, \\\"true\\\", \\\"false\\\")}V,
    \"is_h2_push\":%{if(fastly_info.h2.is_push, \\\"true\\\", \\\"false\\\")}V,
    \"h2_stream_id\":\"%{fastly_info.h2.stream_id}V\",
    \"request_referer\":\"%{Referer}i\",
    \"request_user_agent\":\"%{User-Agent}i\",
    \"request_accept_content\":\"%{Accept}i\",
    \"request_accept_language\":\"%{Accept-Language}i\",
    \"request_accept_encoding\":\"%{Accept-Encoding}i\",
    \"request_accept_charset\":\"%{Accept-Charset}i\",
    \"request_connection\":\"%{Connection}i\",
    \"request_dnt\":\"%{DNT}i\",
    \"request_forwarded\":\"%{Forwarded}i\",
    \"request_via\":\"%{Via}i\",
    \"request_cache_control\":\"%{Cache-Control}i\",
    \"request_x_requested_with\":\"%{X-Requested-With}i\",
    \"request_x_att_device_id\":\"%{X-ATT-Device-Id}i\",
    \"request_x_forwarded_for\":\"%{X-Forwarded-For}i\",
    \"status\":\"%s\",
    \"content_type\":\"%{Content-Type}o\",
    \"cache_status\":\"%{fastly_info.state}V\",
    \"is_cacheable\":%{if(fastly_info.state ~\\\"^(HIT|MISS)$\\\", \\\"true\\\", \\\"false\\\")}V,
    \"response_age\":\"%{Age}o\",
    \"response_cache_control\":\"%{Cache-Control}o\",
    \"response_expires\":\"%{Expires}o\",
    \"response_last_modified\":\"%{Last-Modified}o\",
    \"response_tsv\":\"%{TSV}o\",
    \"server_datacenter\":\"%{server.datacenter}V\",
    \"server_ip\":\"%A\",
    \"geo_city\":\"%{client.geo.city.utf8}V\",
    \"geo_country_code\":\"%{client.geo.country_code}V\",
    \"geo_continent_code\":\"%{client.geo.continent_code}V\",
    \"geo_region\":\"%{client.geo.region}V\",
    \"req_header_size\":%{req.header_bytes_read}V,
    \"req_body_size\":%{req.body_bytes_read}V,
    \"resp_header_size\":%{resp.header_bytes_written}V,
    \"resp_body_size\":%B,
    \"socket_cwnd\":%{client.socket.cwnd}V,
    \"socket_nexthop\":\"%{client.socket.nexthop}V\",
    \"socket_tcpi_rcv_mss\":%{client.socket.tcpi_rcv_mss}V,
    \"socket_tcpi_snd_mss\":%{client.socket.tcpi_snd_mss}V,
    \"socket_tcpi_rtt\":%{client.socket.tcpi_rtt}V,
    \"socket_tcpi_rttvar\":%{client.socket.tcpi_rttvar}V,
    \"socket_tcpi_rcv_rtt\":%{client.socket.tcpi_rcv_rtt}V,
    \"socket_tcpi_rcv_space\":%{client.socket.tcpi_rcv_space}V,
    \"socket_tcpi_last_data_sent\":%{client.socket.tcpi_last_data_sent}V,
    \"socket_tcpi_total_retrans\":%{client.socket.tcpi_total_retrans}V,
    \"socket_tcpi_delta_retrans\":%{client.socket.tcpi_delta_retrans}V,
    \"socket_ploss\":%{client.socket.ploss}V,
    \"backend_name\":\"%{if(req.http.x-nyt-backend,req.http.x-nyt-backend,\\\"\\\")}V\",
    \"pagetype\":\"%{if(req.http.x-nyt-route,req.http.x-nyt-route,\\\"\\\")}V\",
    \"apiversion\":\"%{if(resp.http.X-API-Version,resp.http.X-API-Version,\\\"\\\")}V\",
    \"redirect_reason\":\"%{if(req.http.var-nyt-redirect-reason,regsub(req.http.var-nyt-redirect-reason,\\\"redir=\\\\[([^\\\\]]+)\\\\]\\\",\\\"\\\\1\\\"),\\\"\\\")}V\",
    \"trace_id\": \"%{if(req.http.x-b3-trace-id,req.http.x-b3-trace-id,\\\"\\\")}V\",
    \"backend_healthy\": \"%{if(req.http.x-nyt-backend-health,req.http.x-nyt-backend-health,\\\"\\\")}V\",
    \"restarts\": %{req.restarts}V
    }

# sumo log integration (template data injection )
sumo_log:
  format: >-
    {
    \"service_id\":\"%{req.service_id}V\",
    \"service_version\":\"%{fastly_info.version}V\",
    \"time_start\":\"%{begin:%Y-%m-%dT%H:%M:%S%Z}t\",
    \"time_end\":\"%{end:%Y-%m-%dT%H:%M:%S%Z}t\",
    \"time_elapsed\":\"%D\",
    \"client_ip\":\"%h\",
    \"request\":\"%m\",
    \"proto_ver\":\"%H\",
    \"protocol\":\"%{if(req.http.Fastly-SSL,\\\"https\\\",\\\"http\\\")}V\",
    \"host\":\"%{Fastly-Orig-Host}i\",
    \"origin_host\":\"%v\",
    \"url\":\"%{cstr_escape(req.url)}V\",
    \"is_h2\":\"%{if(fastly_info.is_h2, \\\"true\\\", \\\"false\\\")}V\",
    \"request_referer\":\"%{Referer}i\",
    \"request_user_agent\":\"%{regsub(req.http.User-Agent, \\\"^(.\\{0,200\\}).*\\\", \\\"\\\\1\\\")}V\",
    \"request_accept_content\":\"%{Accept}i\",
    \"request_accept_encoding\":\"%{Accept-Encoding}i\",
    \"request_accept_charset\":\"%{Accept-Charset}i\",
    \"request_cache_control\":\"%{Cache-Control}i\",
    \"status\":\"%s\",
    \"content_type\":\"%{Content-Type}o\",
    \"cachetype\":\"%{fastly_info.state}V\",
    \"response_age\":\"%{Age}o\",
    \"response_cache_control\":\"%{Cache-Control}o\",
    \"response_expires\":\"%{Expires}o\",
    \"response_last_modified\":\"%{Last-Modified}o\",
    \"fastlydc\":\"%{server.datacenter}V\",
    \"geo_city\":\"%{client.geo.city.utf8}V\",
    \"geo_country_code\":\"%{client.geo.country_code}V\",
    \"geo_continent_code\":\"%{client.geo.continent_code}V\",
    \"geo_region\":\"%{client.geo.region}V\",
    \"req_header_size\":\"%{req.header_bytes_read}V\",
    \"req_body_size\":\"%{req.body_bytes_read}V\",
    \"resp_header_size\":\"%{resp.header_bytes_written}V\",
    \"resp_body_size\":\"%B\",
    \"backend\":\"%{if(req.http.x-nyt-backend,req.http.x-nyt-backend,\\\"\\\")}V\",
    \"pagetype\":\"%{if(req.http.x-PageType,req.http.x-PageType,\\\"\\\")}V\",
    \"route\":\"%{if(req.http.x-nyt-route,req.http.x-nyt-route,\\\"\\\")}V\",
    \"is_shield\":\"%{if(req.http.x-nyt-shield-auth,\\\"1\",\\\"0\")}V\",
    \"apiversion\":\"%{if(resp.http.X-API-Version,resp.http.X-API-Version,\\\"\\\")}V\",
    \"behealth\": \"%{if(req.http.x-nyt-backend-health,req.http.x-nyt-backend-health,\\\"\\\")}V\",
    \"redirect_reason\":\"%{if(req.http.x-nyt-redirect-reason,req.http.x-nyt-redirect-reason,\\\"\\\")}V\",
    \"restarts\": \"%{req.restarts}V\",
    \"restart_reason\": \"%{if(req.http.x-nyt-restart-reason,req.http.x-nyt-restart-reason,\\\"\\\")}V\"
    }

datadog_log:
  use_tls: "true"
  tls_hostname: "intake.logs.datadoghq.com"
  address: "intake.logs.datadoghq.com"
  port: "10516"
  format_version: "2"
  message_type: "blank"
  format: >-
    {
    \"ddsource\":\"fastly\",
    \"service\":\"%{req.service_id}V\",
    \"date\":\"%{begin:%Y-%m-%dT%H:%M:%S%Z}t\",
    \"time_start\":\"%{begin:%Y-%m-%dT%H:%M:%S%Z}t\",
    \"time_end\":\"%{end:%Y-%m-%dT%H:%M:%S%Z}t\",
    \"http\":{
    \"request_time_us\":%D,
    \"method\":\"%m\",
    \"url\":\"%{cstr_escape(req.url)}V\",
    \"useragent\":\"%{User-Agent}i\",
    \"referer\":\"%{Referer}i\",
    \"protocol\":\"%H\",
    \"request_x_forwarded_for\":\"%{X-Forwarded-For}i\",
    \"status_code\":%s
    },
    \"network\":{
    \"client\":{
    \"ip\":\"%h\",
    \"name\":\"%{client.as.name}V\",
    \"number\":\"%{client.as.number}V\",
    \"connection_speed\":\"%{client.geo.conn_speed}V\"
    },
    \"destination\":{
    \"ip\":\"%A\"
    },
    \"geoip\":{
    \"geo_city\":\"%{client.geo.city.utf8}V\",
    \"geo_country_code\":\"%{client.geo.country_code}V\",
    \"geo_continent_code\":\"%{client.geo.continent_code}V\",
    \"geo_region\":\"%{client.geo.region}V\"
    },
    \"bytes_written\":%B,
    \"bytes_read\":%{req.body_bytes_read}V
    },
    \"host\":\"%{Fastly-Orig-Host}i\",
    \"origin_host\":\"%v\",
    \"is_ipv6\":%{if(req.is_ipv6,\\\"true\\\",\\\"false\\\")}V,
    \"is_tls\":%{if(req.is_ssl,\\\"true\\\",\\\"false\\\")}V,
    \"tls_client_protocol\":\"%{cstr_escape(tls.client.protocol)}V\",
    \"tls_client_servername\":\"%{cstr_escape(tls.client.servername)}V\",
    \"tls_client_cipher\":\"%{cstr_escape(tls.client.cipher)}V\",
    \"tls_client_cipher_sha\":\"%{cstr_escape(tls.client.ciphers_sha)}V\",
    \"tls_client_tlsexts_sha\":\"%{cstr_escape(tls.client.tlsexts_sha)}V\",
    \"is_h2\":%{if(fastly_info.is_h2,\\\"true\\\",\\\"false\\\")}V,
    \"is_h2_push\":%{if(fastly_info.h2.is_push,\\\"true\\\",\\\"false\\\")}V,
    \"h2_stream_id\":\"%{fastly_info.h2.stream_id}V\",
    \"request_accept_content\":\"%{Accept}i\",
    \"request_accept_language\":\"%{Accept-Language}i\",
    \"request_accept_encoding\":\"%{Accept-Encoding}i\",
    \"request_accept_charset\":\"%{Accept-Charset}i\",
    \"request_connection\":\"%{Connection}i\",
    \"request_dnt\":\"%{DNT}i\",
    \"request_forwarded\":\"%{Forwarded}i\",
    \"request_via\":\"%{Via}i\",
    \"request_cache_control\":\"%{Cache-Control}i\",
    \"request_x_requested_with\":\"%{X-Requested-With}i\",
    \"request_x_att_device_id\":\"%{X-ATT-Device-Id}i\",
    \"content_type\":\"%{Content-Type}o\",
    \"cache_state\":\"%{fastly_info.state}V\",
    \"response_age\":\"%{Age}o\",
    \"response_cache_control\":\"%{Cache-Control}o\",
    \"response_expires\":\"%{Expires}o\",
    \"response_last_modified\":\"%{Last-Modified}o\",
    \"response_tsv\":\"%{TSV}o\",
    \"server_datacenter\":\"%{server.datacenter}V\",
    \"req_header_size\":%{req.header_bytes_read}V,
    \"resp_header_size\":%{resp.header_bytes_written}V,
    \"socket_cwnd\":%{client.socket.cwnd}V,
    \"socket_nexthop\":\"%{client.socket.nexthop}V\",
    \"socket_tcpi_rcv_mss\":%{client.socket.tcpi_rcv_mss}V,
    \"socket_tcpi_snd_mss\":%{client.socket.tcpi_snd_mss}V,
    \"socket_tcpi_rtt\":%{client.socket.tcpi_rtt}V,
    \"socket_tcpi_rttvar\":%{client.socket.tcpi_rttvar}V,
    \"socket_tcpi_rcv_rtt\":%{client.socket.tcpi_rcv_rtt}V,
    \"socket_tcpi_rcv_space\":%{client.socket.tcpi_rcv_space}V,
    \"socket_tcpi_last_data_sent\":%{client.socket.tcpi_last_data_sent}V,
    \"socket_tcpi_total_retrans\":%{client.socket.tcpi_total_retrans}V,
    \"socket_tcpi_delta_retrans\":%{client.socket.tcpi_delta_retrans}V,
    \"socket_ploss\":%{client.socket.ploss}V,
    \"backend\":\"%{if(req.http.x-nyt-backend,req.http.x-nyt-backend,\\\"\\\")}V\",
    \"pagetype\":\"%{if(req.http.x-PageType,req.http.x-PageType,\\\"\\\")}V\",
    \"route\":\"%{if(req.http.x-nyt-route,req.http.x-nyt-route,\\\"\\\")}V\",
    \"is_shield\":\"%{if(req.http.x-nyt-shield-auth,\\\"true\\\",\\\"false\\\")}V\",
    \"behealth\": \"%{if(req.http.x-nyt-backend-health,req.http.x-nyt-backend-health,\\\"\\\")}V\",
    \"redirect_reason\":\"%{if(req.http.x-nyt-redirect-reason,req.http.x-nyt-redirect-reason,\\\"\\\")}V\",
    \"restarts\": \"%{req.restarts}V\",
    \"restart_reason\": \"%{if(req.http.x-nyt-restart-reason,req.http.x-nyt-restart-reason,\\\"\\\")}V\"
    }
  tls_ca_cert: |
    -----BEGIN CERTIFICATE-----
    MIIFcjCCBFqgAwIBAgIQA3sEGznzR/rnIbrKAiOq+zANBgkqhkiG9w0BAQsFADBG
    MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRUwEwYDVQQLEwxTZXJ2ZXIg
    Q0EgMUIxDzANBgNVBAMTBkFtYXpvbjAeFw0xODA5MjEwMDAwMDBaFw0xOTEwMjEx
    MjAwMDBaMB8xHTAbBgNVBAMMFCoubG9ncy5kYXRhZG9naHEuY29tMIIBIjANBgkq
    hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0Y4td+uiC8FoR/kRaZTRFLsRSnfJm5OJ
    UBMu3kuvp1LYFr8OWBwClaDYk5LDccmWYZX5x4p2eVNAvNbPgZ6c612+u+n+TvA2
    tNfeNCrsold/K7YxZQBMgjeTqnEs8bIN2hlaxoa0IqYD47wv8KqZAeBr/pRwhC3S
    IXuLobs3yaE2J20U4sWeYCb6IPHioZB1y1olATODeK4SP+tTAtmsVeCPYivrFxLw
    EapwNOywH2AupeYIEa9XX+sQ5Gjp+k1KQj64gfnT2dieQHWClOzra9tKjItAo5QF
    t2X79KFdSrf7KGKatHWXV/jfcGFA0NoosXBFcQV1qPHYj6N/4txSlwIDAQABo4IC
    gTCCAn0wHwYDVR0jBBgwFoAUWaRmBlKge5WSPKOUByeWdFv5PdAwHQYDVR0OBBYE
    FB3XQuGJSGyn5zJ/XPqpL08kx5cYMB8GA1UdEQQYMBaCFCoubG9ncy5kYXRhZG9n
    aHEuY29tMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYB
    BQUHAwIwOwYDVR0fBDQwMjAwoC6gLIYqaHR0cDovL2NybC5zY2ExYi5hbWF6b250
    cnVzdC5jb20vc2NhMWIuY3JsMCAGA1UdIAQZMBcwCwYJYIZIAYb9bAECMAgGBmeB
    DAECATB1BggrBgEFBQcBAQRpMGcwLQYIKwYBBQUHMAGGIWh0dHA6Ly9vY3NwLnNj
    YTFiLmFtYXpvbnRydXN0LmNvbTA2BggrBgEFBQcwAoYqaHR0cDovL2NydC5zY2Ex
    Yi5hbWF6b250cnVzdC5jb20vc2NhMWIuY3J0MAwGA1UdEwEB/wQCMAAwggEFBgor
    BgEEAdZ5AgQCBIH2BIHzAPEAdgCkuQmQtBhYFIe7E6LMZ3AKPDWYBPkb37jjd80O
    yA3cEAAAAWX8fVk3AAAEAwBHMEUCIEIwg4Cnl5IYmFEk0GU7cOBX6tmjn/OMCxXb
    FjP6mwTFAiEA4MuhLM2NpuAF3dfBa9qJxTlkTb5Rh8Plf2zibMebej4AdwCHdb/n
    WXz4jEOZX73zbv9WjUdWNv9KtWDBtOr/XqCDDwAAAWX8fVoKAAAEAwBIMEYCIQD4
    cCBzgOe96fEcxgl+pfNPDiRPtMNdptPxv7EknDlV4wIhANFBPUxaJYua33FM22M1
    dOTUxWiegS7vP+P5M+Gi5OAYMA0GCSqGSIb3DQEBCwUAA4IBAQB36ZyXXhehpTXl
    gvQRMjEbl6yTxejbk/0LTjxKvHNLonPaiWFLGRi6E4e1kYlevvWvgogA7BXKyAjb
    xlEj7QJCRn3ZtgNxlbd56yr3nHGvk9Jl9XX3q7ekr/QnzJqb97shuXCqskoSAHIF
    mcBMhcy23fvBePuRAIKl/+SOPzqAYemo1T/WpeAhgIQpUgzU1qblnJzCgsC7V0PZ
    13zbzomz3JmaChSHfhrUGW5tTHYy05IwKazNQmlGlIg/CAbB7IyzK2JkryEUiWBm
    CUtgE9Wo/bEw/UQaiHviSV+Xm8XkfeKNqfc60y2CD0z7vJZti678iC4zuhHxn8EY
    OyhLsAXF
    -----END CERTIFICATE-----
    
