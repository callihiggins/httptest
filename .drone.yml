pipeline:

  # First step is yml file syntax check for all environment
  yml_syntax_check:
    image: inzinger/alpine-ruby:2.3
    commands:
      - ruby -r yaml -e 'YAML.parse(File.open("./var-dev.yml"))'
      - ruby -r yaml -e 'YAML.parse(File.open("./var-stg.yml"))'
      - ruby -r yaml -e 'YAML.parse(File.open("./var-prd.yml"))'

  # This step runs the template engine for sandbox and dev services
  # notice we are setting an env for dev that will trigger
  # dev specific domain templating (dev + sandboxes)
  # someday if .sbx.nytimes.com is not Vi alpha service only we will iterate
  dev-template:
    image: hairyhenderson/gomplate:v2.3.0
    environment:
      - env=dev
    commands:
      - /gomplate -f main.tmpl -o main.tf -d config=var-dev.yml
      - /gomplate -f builds/www.stg.nytimes.com/route-health-service.tmpl -o builds/www.stg.nytimes.com/route-health-service.vcl -d config=var-dev.yml
    when:
      event: push
      branch:
        exclude: [ master ]

  # this step is used to validate the Terraform syntax before attempting apply
  # the terraform configuration to the service, it essentially runs: terraform plan
  # it's ok that this uses dev service for everything, just a plan to validate tf
  tf_syntax_check:
    image: jmccann/drone-terraform:4.0-0.10.7
    plan: true
    init_options:
      backend-config:
        - "path=fastly/fastly-www/dev/terraform.tfstate"
    vars:
      env: dev
      service_name: dev
    secrets:
      - source: fastly_api_key_dev
        target: FASTLY_API_KEY

      - source: google_credentials
        target: GOOGLE_CREDENTIALS
    when:
      event: push
      branch:
        exclude: [ master ]

  # SANDBOX: uses branch sandbox01 to deploy to www.sandbox01
  sandbox01:
    image: jmccann/drone-terraform:4.0-0.10.7
    plan: false
    init_options:
      backend-config:
        - "path=fastly/fastly-www/sandbox01/terraform.tfstate"
    vars:
      env: dev
      service_name: sandbox01
    secrets:
      - source: fastly_api_key_dev
        target: FASTLY_API_KEY

      - source: google_credentials
        target: GOOGLE_CREDENTIALS
    when:
      event: push
      branch:
        include: [ sandbox01 ]
    
  # Run tests against dev service in sandbox01
  sandbox01-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: www-sandbox01.dev.nytimes.com
    print_failures_only: true
    when:
      event: push
      branch:
        include: [ sandbox01 ]

  # SANDBOX: uses branch sandbox02 to deploy to www.sandbox02
  sandbox02:
    image: jmccann/drone-terraform:4.0-0.10.7
    plan: false
    init_options:
      backend-config:
        - "path=fastly/fastly-www/sandbox02/terraform.tfstate"
    vars:
      env: dev
      service_name: sandbox02
    secrets:
      - source: fastly_api_key_dev
        target: FASTLY_API_KEY

      - source: google_credentials
        target: GOOGLE_CREDENTIALS
    when:
      event: push
      branch:
        include: [ sandbox02 ]
    
  # Run tests against dev service in sandbox02
  sandbox02-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: www-sandbox02.dev.nytimes.com
    print_failures_only: true
    when:
      event: push
      branch:
        include: [ sandbox02 ]

  # SANDBOX: uses branch sandbox03 to deploy to www.sandbox03
  sandbox03:
    image: jmccann/drone-terraform:4.0-0.10.7
    plan: false
    init_options:
      backend-config:
        - "path=fastly/fastly-www/sandbox03/terraform.tfstate"
    vars:
      env: dev
      service_name: sandbox03
    secrets:
      - source: fastly_api_key_dev
        target: FASTLY_API_KEY

      - source: google_credentials
        target: GOOGLE_CREDENTIALS
    when:
      event: push
      branch:
        include: [ sandbox03 ]
  
  # Run tests against dev service in sandbox03
  sandbox03-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: www-sandbox03.dev.nytimes.com
    print_failures_only: true
    when:
      event: push
      branch:
        include: [ sandbox03 ]


  # SANDBOX: uses branch sandbox04 to deploy to www.sandbox04
  sandbox04:
    image: jmccann/drone-terraform:4.0-0.10.7
    plan: false
    init_options:
      backend-config:
        - "path=fastly/fastly-www/sandbox04/terraform.tfstate"
    vars:
      env: dev
      service_name: sandbox04
    secrets:
      - source: fastly_api_key_dev
        target: FASTLY_API_KEY

      - source: google_credentials
        target: GOOGLE_CREDENTIALS
    when:
      event: push
      branch:
        include: [ sandbox04 ]

  # Run tests against dev service in sandbox04
  sandbox04-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: www-sandbox04.dev.nytimes.com
    print_failures_only: true
    when:
      event: push
      branch:
        include: [ sandbox04 ]

  # DEV: Deploy to www.dev service
  dev:
    image: jmccann/drone-terraform:4.0-0.10.7
    plan: false
    init_options:
      backend-config:
        - "path=fastly/fastly-www/dev/terraform.tfstate"
    vars:
      env: dev
      service_name: dev
    secrets:
      - source: fastly_api_key_dev
        target: FASTLY_API_KEY

      - source: google_credentials
        target: GOOGLE_CREDENTIALS
    when:
      event: push
      branch:
        exclude: [ sandbox01, sandbox02, sandbox03, sandbox04, master ]

  dev-sleep:
    image: alpine
    commands:
      - sleep 10
    when:
      event: push
      branch:
        exclude: [ sandbox01, sandbox02, sandbox03, sandbox04, master ]

  # Run tests against dev service
  dev-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: www.dev.nytimes.com
    print_failures_only: true
    when:
      event: push
    branch:
        exclude: [ sandbox01, sandbox02, sandbox03, sandbox04, master ]

  # Run tests against dev service
  dev-paidpost-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: paidpost.dev.nytimes.com
    print_failures_only: true
    when:
      event: push
      branch:
        exclude: [ sandbox01, sandbox02, sandbox03, sandbox04, master ]  
      status: [success, failure]  

  stg-template:
    image: hairyhenderson/gomplate:v2.3.0
    commands:
      - /gomplate -f main.tmpl -o main.tf -d config=var-stg.yml
      - /gomplate -f builds/www.stg.nytimes.com/route-health-service.tmpl -o builds/www.stg.nytimes.com/route-health-service.vcl -d config=var-stg.yml
    when:
      event: push
      branch: master

  # --------
  # Deployment to staging service
  staging:
    image: jmccann/drone-terraform:4.0-0.10.7
    plan: false
    init_options:
      backend-config:
        - "path=fastly/fastly-www/stg/terraform.tfstate"
    vars:
      env: stg
      service_name: stg
    secrets:
      - source: fastly_api_key_stg
        target: FASTLY_API_KEY

      - source: google_credentials
        target: GOOGLE_CREDENTIALS
    when:
      event: push
      branch: master

  stg-sleep:
    image: alpine
    commands:
      - sleep 10
    when:
      event: push
      branch: master

  stg-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: www.stg.nytimes.com
    print_failures_only: true
    when:
      event: push
      branch: master

  stg-paidpost-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: paidpost.stg.nytimes.com
    print_failures_only: true
    when:
      event: push
      branch: master
      status: [success, failure]

  # -----
  prd-template:
    image: hairyhenderson/gomplate:v2.3.0
    commands:
      - /gomplate -f main.tmpl -o main.tf -d config=var-prd.yml
      - /gomplate -f builds/www.stg.nytimes.com/route-health-service.tmpl -o builds/www.stg.nytimes.com/route-health-service.vcl -d config=var-prd.yml
    when:
      event: tag
      branch: [ master, hotfix* ]

 # Deployment to production service
  production:
    image: jmccann/drone-terraform:4.0-0.10.7
    plan: false
    init_options:
      backend-config:
        - "path=fastly/fastly-www/prd/terraform.tfstate"
    vars:
      env: prd
      service_name: prd
    secrets:
      - source: fastly_api_key_prd
        target: FASTLY_API_KEY

      - source: google_credentials
        target: GOOGLE_CREDENTIALS
    when:
      event: tag
      branch: [ master, hotfix* ]

  prd-sleep:
    image: alpine
    commands:
      - sleep 10
    when:
      event: tag

  prd-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: www.nytimes.com
    print_failures_only: true
    when:
      event: tag
      branch: [ master, hotfix* ]

  prd-paidpost-test:
    image: us.gcr.io/nyt-registry-prd/drone-fastly-tests
    servername: paidpost.nytimes.com
    print_failures_only: true
    when:
      event: tag
      branch: [ master, hotfix* ]
      status: [success, failure]

  slack:
    image: plugins/slack
    channel: fastly-builds
    username: fastly-www
    secrets: [SLACK_WEBHOOK]
    when:
      status: [success, failure, blocked]
